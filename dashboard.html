<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</title>
    
    <style>
        :root {
            --admin-color: #2c3e50;
            --admin-secondary: #34495e;
            --admin-accent: #1abc9c;
            --admin-warning: #e74c3c;
            --admin-success: #27ae60;
            --admin-info: #3498db;
            --admin-light: #ecf0f1;
            --admin-dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: var(--admin-light);
            direction: rtl;
            min-height: 100vh;
        }

        .header {
            background: rgba(44, 62, 80, 0.95);
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-bottom: 4px solid var(--admin-accent);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--admin-accent) 0%, var(--admin-info) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
        }

        .logo-text h1 {
            font-size: 32px;
            color: white;
            margin-bottom: 8px;
            font-weight: 800;
        }

        .logo-text p {
            color: #bdc3c7;
            font-size: 16px;
            font-weight: 500;
        }

        .admin-controls {
            display: flex;
            gap: 15px;
        }

        .admin-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .admin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .main-container {
            max-width: 1800px;
            margin: 40px auto;
            padding: 0 30px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 3px solid var(--admin-accent);
            height: fit-content;
            position: sticky;
            top: 40px;
        }

        .sidebar-section {
            margin-bottom: 35px;
        }

        .sidebar-title {
            color: var(--admin-color);
            font-size: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            color: var(--admin-color);
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: #f8f9fa;
            border-color: var(--admin-accent);
            transform: translateX(-5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--admin-accent) 0%, #16a085 100%);
            color: white;
            border-color: var(--admin-accent);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.3);
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .system-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 800;
            color: var(--admin-color);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #6c757d;
            font-weight: 600;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 3px solid var(--admin-accent);
        }

        .content-header {
            margin-bottom: 40px;
        }

        .content-title {
            color: var(--admin-color);
            font-size: 32px;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .content-subtitle {
            color: #6c757d;
            font-size: 18px;
            line-height: 1.6;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        .evaluation-manager {
            overflow-x: auto;
        }

        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 10px;
            color: var(--admin-color);
            font-weight: 600;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ced4da;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: var(--admin-color);
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 4px rgba(26, 188, 156, 0.1);
        }

        .search-box {
            position: relative;
            flex: 2;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid #ced4da;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: var(--admin-color);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 20px;
        }

        .evaluations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .evaluations-table th {
            background: linear-gradient(135deg, var(--admin-color) 0%, var(--admin-secondary) 100%);
            color: white;
            padding: 20px;
            text-align: right;
            font-weight: 600;
            font-size: 16px;
        }

        .evaluations-table td {
            padding: 18px 20px;
            border-bottom: 2px solid #f1f5f9;
            color: var(--admin-color);
            font-size: 15px;
        }

        .evaluations-table tr:hover {
            background: #f8f9fa;
        }

        .evaluations-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-view {
            background: #d1ecf1;
            color: #0c5460;
        }

        .btn-edit {
            background: #d4edda;
            color: #155724;
        }

        .btn-delete {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-restore {
            background: #fff3cd;
            color: #856404;
        }

        .btn-print {
            background: #cce5ff;
            color: #004085;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 25px;
            padding: 40px;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f1f5f9;
        }

        .modal-title {
            color: var(--admin-color);
            font-size: 28px;
            font-weight: 800;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #6c757d;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--admin-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                padding: 20px;
            }
            
            .admin-controls {
                width: 100%;
                justify-content: center;
            }
            
            .admin-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .main-container {
                padding: 20px;
                margin: 20px auto;
            }
            
            .content-area {
                padding: 25px;
            }
            
            .filters-bar {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <header class="header">
        <div class="logo-section">
            <div class="logo">âš™ï¸</div>
            <div class="logo-text">
                <h1>Ù„ÙˆØ­Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
            </div>
        </div>
        <div class="admin-controls">
            <button class="admin-btn btn-refresh" onclick="refreshSystem()">
                ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
            </button>
            <button class="admin-btn btn-logout" onclick="logout()">
                ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                            <span class="nav-icon">ğŸ“Š</span>
                            <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#evaluations" class="nav-link" onclick="showSection('evaluations')">
                            <span class="nav-icon">ğŸ“</span>
                            <span>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#employees" class="nav-link" onclick="showSection('employees')">
                            <span class="nav-icon">ğŸ‘¥</span>
                            <span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#reports" class="nav-link" onclick="showSection('reports')">
                            <span class="nav-icon">ğŸ“ˆ</span>
                            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <div class="system-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalEvaluations">0</div>
                        <div class="stat-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalEmployees">0</div>
                        <div class="stat-label">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pendingCount">0</div>
                        <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="deletedCount">0</div>
                        <div class="stat-label">Ù…Ø­Ø°ÙˆÙØ©</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <div style="color: var(--admin-color); font-size: 14px; line-height: 1.6;">
                    <p><strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> 2.0.1</p>
                    <p><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> <span id="lastUpdate"></span></p>
                    <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span style="color: var(--admin-success);">ğŸŸ¢ Ù†Ø´Ø·</span></p>
                    <p><strong>Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„:</strong> <span id="currentAdmin">-</span></p>
                </div>
            </div>
        </aside>

        <main class="content-area">
            <section id="dashboard" class="content-section active">
                <div class="content-header">
                    <h2 class="content-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                    <p class="content-subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</p>
                </div>
                
                <div class="system-stats" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
                    <div class="stat-item" style="background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);">
                        <div class="stat-number" id="activeEmployees">0</div>
                        <div class="stat-label">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #e8f8e8 0%, #d4edda 100%);">
                        <div class="stat-number" id="completedEvals">0</div>
                        <div class="stat-label">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);">
                        <div class="stat-number" id="todayEvals">0</div>
                        <div class="stat-label">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    </div>
                    <div class="stat-item" style="background: linear-gradient(135deg, #f8e8e8 0%, #f8d7da 100%);">
                        <div class="stat-number" id="needAction">0</div>
                        <div class="stat-label">ØªØ­ØªØ§Ø¬ Ø¥Ø¬Ø±Ø§Ø¡</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-top: 30px;">
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 20px; border: 2px solid #e9ecef;">
                        <h3 style="color: var(--admin-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ“‹ Ø£Ø­Ø¯Ø« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                        </h3>
                        <div id="recentEvaluations" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: #6c757d; text-align: center; padding: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 20px; border: 2px solid #e9ecef;">
                        <h3 style="color: var(--admin-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            âš ï¸ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø­Ø°ÙˆÙØ©
                        </h3>
                        <div id="deletedEvalsList" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: #6c757d; text-align: center; padding: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="evaluations" class="content-section">
                <div class="content-header">
                    <h2 class="content-title">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
                    <p class="content-subtitle">Ø¹Ø±Ø¶ØŒ Ø­Ø°ÙØŒ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</p>
                </div>
                
                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Ø§Ù„ÙØ±Ø¹:</label>
                        <select id="filterBranch" class="filter-select" onchange="filterEvaluations()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                        <select id="filterStatus" class="filter-select" onchange="filterEvaluations()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
                            <option value="deleted">Ù…Ø­Ø°ÙˆÙ</option>
                        </select>
                    </div>
                    <div class="search-box">
                        <label class="filter-label">Ø¨Ø­Ø«:</label>
                        <input type="text" id="searchEvaluations" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…..." oninput="searchEvaluations()">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                </div>

                <div class="evaluation-manager">
                    <table class="evaluations-table" id="evaluationsTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <th>Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…</th>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                                <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="evaluationsBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="employees" class="content-section">
                <div class="content-header">
                    <h2 class="content-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
                    <p class="content-subtitle">Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                </div>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Ø§Ù„ÙØ±Ø¹:</label>
                        <select id="filterEmpBranch" class="filter-select" onchange="filterEmployees()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ø§Ù„Ø¯ÙˆØ±:</label>
                        <select id="filterEmpRole" class="filter-select" onchange="filterEmployees()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
                        </select>
                    </div>
                    <div class="search-box">
                        <label class="filter-label">Ø¨Ø­Ø«:</label>
                        <input type="text" id="searchEmployees" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..." oninput="searchEmployees()">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                </div>

                <div class="evaluation-manager">
                    <table class="evaluations-table" id="employeesTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>Ø§Ù„Ù…Ø¯ÙŠØ±</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="employeesBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="reports" class="content-section">
                <div class="content-header">
                    <h2 class="content-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
                    <p class="content-subtitle">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-top: 20px;">
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 20px; border: 2px solid var(--admin-accent);">
                        <h3 style="color: var(--admin-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ‘¤ ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ¸Ù
                        </h3>
                        <div style="margin-bottom: 20px;">
                            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                            <select id="reportEmployee" class="filter-select">
                                <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                            </select>
                        </div>
                        <button class="admin-btn" onclick="generateEmployeeReport()" style="width: 100%; padding: 15px; background: var(--admin-accent);">
                            ğŸ“„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 20px; border: 2px solid var(--admin-info);">
                        <h3 style="color: var(--admin-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ“‹ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚ÙŠÙŠÙ… ÙƒØ§Ù…Ù„
                        </h3>
                        <div style="margin-bottom: 20px;">
                            <label class="form-label">Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…:</label>
                            <select id="printEvaluation" class="filter-select">
                                <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                            </select>
                        </div>
                        <button class="admin-btn" onclick="printFullEvaluation()" style="width: 100%; padding: 15px; background: var(--admin-info);">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ§Ù…Ù„Ø©
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 20px; border: 2px solid var(--admin-success);">
                        <h3 style="color: var(--admin-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ
                        </h3>
                        <div style="margin-bottom: 20px;">
                            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
                            <select id="reportType" class="filter-select">
                                <option value="summary">Ù…Ù„Ø®Øµ Ø¹Ø§Ù…</option>
                                <option value="branches">Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙˆØ¹</option>
                                <option value="roles">Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
                                <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                            </select>
                        </div>
                        <button class="admin-btn" onclick="generateStatsReport()" style="width: 100%; padding: 15px; background: var(--admin-success);">
                            ğŸ“Š ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="actionModal" class="modal" onclick="if(event.target.id === 'actionModal') closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div id="modalContent">
                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====================
        const SUPABASE_URL = 'https://pzsxhypigslcvduegvpa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6c3hoeXBpZ3NsY3ZkdWVndnBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTMxOTQsImV4cCI6MjA4MTA2OTE5NH0.0LC452nPLSywGh1mKxNQedm3M_yWZ4srck-gK67iZag';
        
        let supabase;
        let currentUser = null;
        let allEvaluations = [];
        let filteredEvaluations = [];
        let allEmployees = [];
        let filteredEmployees = [];
        let allQuestions = [];
        let systemStats = {
            totalEvaluations: 0,
            totalEmployees: 0,
            pendingCount: 0,
            deletedCount: 0,
            activeEmployees: 0,
            completedEvals: 0,
            todayEvals: 0,
            needAction: 0
        };

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...');
            
            try {
                currentUser = JSON.parse(localStorage.getItem('caritas_user'));
                if (!currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø¯ÙˆØ± 7)
                if (currentUser.role_id !== 7) {
                    alert('â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                document.getElementById('currentAdmin').textContent = currentUser.full_name;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('ar-SA');

                supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('âœ… Supabase client initialized');

                await loadAllData();
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        });

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showError(message) {
            alert('âŒ Ø®Ø·Ø£: ' + message);
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[href="#${sectionId}"]`).classList.add('active');
        }

        function getRoleName(roleId) {
            const roles = {
                1: 'Ø£Ø®ØµØ§Ø¦ÙŠ Ù…ÙŠØ¯Ø§Ù†ÙŠ',
                2: 'Ù…Ø³Ø¤ÙˆÙ„ ÙØ±ÙŠÙ‚',
                3: 'Ù…Ø¯ÙŠØ± ÙØ±Ø¹',
                4: 'Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·',
                5: 'Ø¥Ø¯Ø§Ø±ÙŠ',
                6: 'Ù…Ø±ÙƒØ² Ø±Ø¦ÙŠØ³ÙŠ',
                7: 'Ù…Ø³Ø¦ÙˆÙ„ Ù†Ø¸Ø§Ù…'
            };
            return roles[roleId] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function getBranchName(branch) {
            if (!branch) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            return branch.replace('ÙØ±Ø¹ ', '');
        }

        function formatDate(dateString) {
            if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            return new Date(dateString).toLocaleDateString('ar-SA');
        }

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
        async function loadAllData() {
            showLoading();
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                await loadEmployees();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                await loadEvaluations();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                await loadQuestions();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ±
                updateFilters();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                updateStats();
                
                // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                loadDashboardData();
                
                hideLoading();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        async function loadEmployees() {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('full_name');

                if (error) throw error;
                
                allEmployees = data || [];
                filteredEmployees = [...allEmployees];
                renderEmployeesTable();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:', error);
                throw error;
            }
        }

        async function loadEvaluations() {
            try {
                const { data, error } = await supabase
                    .from('evaluation_results')
                    .select(`
                        *,
                        evaluated_employee:employees!evaluated_employee_id(full_name, branch, role_id),
                        evaluator:employees!evaluator_id(full_name, branch)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                allEvaluations = data || [];
                filteredEvaluations = [...allEvaluations];
                renderEvaluationsTable();
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                updatePrintSelect();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:', error);
                throw error;
            }
        }

        async function loadQuestions() {
            try {
                const { data, error } = await supabase
                    .from('evaluation_questions')
                    .select('*')
                    .order('question_order');

                if (error) throw error;
                
                allQuestions = data || [];
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
                allQuestions = [];
            }
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ± ====================
        function updateFilters() {
            // ØªØ­Ø¯ÙŠØ« ÙÙ„Ø§ØªØ± Ø§Ù„ÙØ±ÙˆØ¹
            const branches = [...new Set(allEmployees.map(emp => emp.branch).filter(Boolean))];
            const branchFilter = document.getElementById('filterBranch');
            const empBranchFilter = document.getElementById('filterEmpBranch');
            
            [branchFilter, empBranchFilter].forEach(filter => {
                if (filter) {
                    filter.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option>';
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = getBranchName(branch);
                        filter.appendChild(option);
                    });
                }
            });

            // ØªØ­Ø¯ÙŠØ« ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
            const roles = [...new Set(allEmployees.map(emp => emp.role_id))];
            const roleFilter = document.getElementById('filterEmpRole');
            if (roleFilter) {
                roleFilter.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>';
                roles.forEach(roleId => {
                    const option = document.createElement('option');
                    option.value = roleId;
                    option.textContent = getRoleName(roleId);
                    roleFilter.appendChild(option);
                });
            }

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„ØªÙ‚Ø±ÙŠØ±
            const reportEmployee = document.getElementById('reportEmployee');
            if (reportEmployee) {
                reportEmployee.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>';
                allEmployees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.full_name} (${getBranchName(employee.branch)})`;
                    reportEmployee.appendChild(option);
                });
            }
        }

        function updatePrintSelect() {
            const printSelect = document.getElementById('printEvaluation');
            if (!printSelect) return;
            
            printSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…</option>';
            
            const completedEvals = allEvaluations.filter(e => !e.is_deleted && e.status === 'completed');
            
            completedEvals.forEach(eval => {
                const employee = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                if (employee) {
                    const option = document.createElement('option');
                    option.value = eval.id;
                    option.textContent = `${employee.full_name} - ${formatDate(eval.created_at)}`;
                    printSelect.appendChild(option);
                }
            });
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====================
        function updateStats() {
            systemStats.totalEvaluations = allEvaluations.length;
            systemStats.totalEmployees = allEmployees.length;
            systemStats.pendingCount = allEvaluations.filter(e => !e.is_deleted && e.status === 'pending').length;
            systemStats.deletedCount = allEvaluations.filter(e => e.is_deleted).length;
            systemStats.activeEmployees = allEmployees.filter(e => e.is_active).length;
            systemStats.completedEvals = allEvaluations.filter(e => !e.is_deleted && e.status === 'completed').length;
            
            // ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ…
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            systemStats.todayEvals = allEvaluations.filter(e => 
                new Date(e.created_at) >= today && !e.is_deleted
            ).length;

            document.getElementById('totalEvaluations').textContent = systemStats.totalEvaluations;
            document.getElementById('totalEmployees').textContent = systemStats.totalEmployees;
            document.getElementById('pendingCount').textContent = systemStats.pendingCount;
            document.getElementById('deletedCount').textContent = systemStats.deletedCount;
            document.getElementById('activeEmployees').textContent = systemStats.activeEmployees;
            document.getElementById('completedEvals').textContent = systemStats.completedEvals;
            document.getElementById('todayEvals').textContent = systemStats.todayEvals;
            document.getElementById('needAction').textContent = systemStats.pendingCount;
        }

        // ==================== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ====================
        function loadDashboardData() {
            loadRecentEvaluations();
            loadDeletedEvaluationsList();
        }

        function loadRecentEvaluations() {
            const container = document.getElementById('recentEvaluations');
            const recentEvals = allEvaluations
                .filter(e => !e.is_deleted)
                .slice(0, 10);
            
            if (recentEvals.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø­Ø¯ÙŠØ«Ø©</p>';
                return;
            }
            
            let html = '';
            recentEvals.forEach(eval => {
                const employee = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                if (!employee) return;
                
                const timeAgo = getTimeAgo(eval.created_at);
                const statusColor = eval.status === 'completed' ? '#27ae60' : '#f39c12';
                const statusText = eval.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e9ecef; background: white; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <strong style="font-size: 14px;">${employee.full_name}</strong>
                            <div style="font-size: 12px; color: #6c757d;">
                                ${timeAgo} | ${getBranchName(employee.branch)}
                            </div>
                        </div>
                        <div>
                            <span style="font-size: 12px; padding: 4px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px;">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadDeletedEvaluationsList() {
            const container = document.getElementById('deletedEvalsList');
            const deletedEvals = allEvaluations
                .filter(e => e.is_deleted)
                .slice(0, 10);
            
            if (deletedEvals.length === 0) {
                container.innerHTML = '<p style="color: #27ae60; text-align: center; padding: 20px; font-weight: bold;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø­Ø°ÙˆÙØ©</p>';
                return;
            }
            
            let html = '';
            deletedEvals.forEach(eval => {
                const employee = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                if (!employee) return;
                
                const timeAgo = getTimeAgo(eval.created_at);
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e9ecef; background: white; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <strong style="font-size: 14px;">${employee.full_name}</strong>
                            <div style="font-size: 12px; color: #6c757d;">
                                ${timeAgo} | ${getBranchName(employee.branch)}
                            </div>
                        </div>
                        <div>
                            <button onclick="restoreEvaluation('${eval.id}')" style="padding: 4px 8px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 60) return `Ù‚Ø¨Ù„ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffHours < 24) return `Ù‚Ø¨Ù„ ${diffHours} Ø³Ø§Ø¹Ø©`;
            if (diffDays < 7) return `Ù‚Ø¨Ù„ ${diffDays} ÙŠÙˆÙ…`;
            return formatDate(dateString);
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ====================
        function renderEvaluationsTable() {
            const tbody = document.getElementById('evaluationsBody');
            
            if (filteredEvaluations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            
            filteredEvaluations.forEach(evaluation => {
                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                const evaluatorName = evaluation.evaluator?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const employeeName = employee?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const branch = employee?.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„
                const question = allQuestions.find(q => q.id === evaluation.question_id);
                const questionText = question ? (question.question_text.length > 50 ? 
                    question.question_text.substring(0, 50) + '...' : question.question_text) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                const statusText = evaluation.is_deleted ? 'Ù…Ø­Ø°ÙˆÙ' : 
                    (evaluation.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
                const statusClass = evaluation.is_deleted ? 'status-deleted' : 
                    (evaluation.status === 'completed' ? 'status-completed' : 'status-pending');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(evaluation.created_at)}</td>
                    <td><strong>${employeeName}</strong></td>
                    <td>${evaluatorName}</td>
                    <td>${getBranchName(branch)}</td>
                    <td title="${question?.question_text || ''}">${questionText}</td>
                    <td><strong style="color: ${getScoreColor(evaluation.score)}">${evaluation.score || 0}/10</strong></td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-view" onclick="viewEvaluation('${evaluation.id}')">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶
                            </button>
                            ${evaluation.is_deleted ? 
                                `<button class="action-btn btn-restore" onclick="restoreEvaluation('${evaluation.id}')">
                                    ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                </button>` : 
                                `<button class="action-btn btn-delete" onclick="deleteEvaluation('${evaluation.id}')">
                                    ğŸ—‘ï¸ Ø­Ø°Ù
                                </button>`
                            }
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function filterEvaluations() {
            const branchFilter = document.getElementById('filterBranch').value;
            const statusFilter = document.getElementById('filterStatus').value;

            filteredEvaluations = allEvaluations.filter(evaluation => {
                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                if (!employee) return false;

                if (branchFilter !== 'all' && employee.branch !== branchFilter) {
                    return false;
                }

                if (statusFilter === 'completed' && (evaluation.is_deleted || evaluation.status !== 'completed')) {
                    return false;
                }
                if (statusFilter === 'pending' && (evaluation.is_deleted || evaluation.status !== 'pending')) {
                    return false;
                }
                if (statusFilter === 'deleted' && !evaluation.is_deleted) {
                    return false;
                }
                if (statusFilter !== 'deleted' && evaluation.is_deleted) {
                    return false;
                }
                
                return true;
            });

            renderEvaluationsTable();
        }

        function searchEvaluations() {
            const searchTerm = document.getElementById('searchEvaluations').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredEvaluations = [...allEvaluations];
                renderEvaluationsTable();
                return;
            }
            
            filteredEvaluations = allEvaluations.filter(evaluation => {
                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                const evaluatorName = evaluation.evaluator?.full_name || '';
                const employeeName = employee?.full_name || '';
                
                return (
                    employeeName.toLowerCase().includes(searchTerm) ||
                    evaluatorName.toLowerCase().includes(searchTerm) ||
                    (employee?.branch?.toLowerCase() || '').includes(searchTerm)
                );
            });

            renderEvaluationsTable();
        }

        function getScoreColor(score) {
            if (score >= 9) return '#27ae60'; // Ù…Ù…ØªØ§Ø²
            if (score >= 7) return '#f39c12'; // Ø¬ÙŠØ¯
            if (score >= 5) return '#e67e22'; // Ù…ØªÙˆØ³Ø·
            return '#e74c3c'; // Ø¶Ø¹ÙŠÙ
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ====================
        function renderEmployeesTable() {
            const tbody = document.getElementById('employeesBody');
            
            if (filteredEmployees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            
            filteredEmployees.forEach(employee => {
                const manager = allEmployees.find(e => e.id === employee.manager_id);
                const statusText = employee.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                const statusClass = employee.is_active ? 'status-completed' : 'status-deleted';
                const hireDate = employee.hire_date ? formatDate(employee.hire_date) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${employee.full_name}</strong></td>
                    <td><code>${employee.username}</code></td>
                    <td>${getRoleName(employee.role_id)}</td>
                    <td>${getBranchName(employee.branch)}</td>
                    <td>${manager?.full_name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>${hireDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-view" onclick="viewEmployee('${employee.id}')">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶
                            </button>
                            <button class="action-btn btn-edit" onclick="editEmployee('${employee.id}')">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function filterEmployees() {
            const branchFilter = document.getElementById('filterEmpBranch').value;
            const roleFilter = document.getElementById('filterEmpRole').value;

            filteredEmployees = allEmployees.filter(employee => {
                if (branchFilter !== 'all' && employee.branch !== branchFilter) {
                    return false;
                }
                
                if (roleFilter !== 'all' && employee.role_id.toString() !== roleFilter) {
                    return false;
                }
                
                return true;
            });

            renderEmployeesTable();
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('searchEmployees').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredEmployees = [...allEmployees];
                renderEmployeesTable();
                return;
            }
            
            filteredEmployees = allEmployees.filter(employee => {
                return (
                    (employee.full_name?.toLowerCase() || '').includes(searchTerm) ||
                    (employee.username?.toLowerCase() || '').includes(searchTerm) ||
                    (employee.branch?.toLowerCase() || '').includes(searchTerm)
                );
            });

            renderEmployeesTable();
        }

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ====================
        async function deleteEvaluation(evaluationId) {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.')) {
                return;
            }

            showLoading();
            
            try {
                const { error } = await supabase
                    .from('evaluation_results')
                    .update({ is_deleted: true })
                    .eq('id', evaluationId);
                
                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const evalIndex = allEvaluations.findIndex(e => e.id === evaluationId);
                if (evalIndex !== -1) {
                    allEvaluations[evalIndex].is_deleted = true;
                }

                filteredEvaluations = filteredEvaluations.map(e => 
                    e.id === evaluationId ? {...e, is_deleted: true} : e
                );

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                updateStats();
                renderEvaluationsTable();
                loadDeletedEvaluationsList();
                hideLoading();

                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
            }
        }

        async function restoreEvaluation(evaluationId) {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ')) {
                return;
            }

            showLoading();

            try {
                const { error } = await supabase
                    .from('evaluation_results')
                    .update({ is_deleted: false })
                    .eq('id', evaluationId);
                
                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const evalIndex = allEvaluations.findIndex(e => e.id === evaluationId);
                if (evalIndex !== -1) {
                    allEvaluations[evalIndex].is_deleted = false;
                }

                filteredEvaluations = filteredEvaluations.map(e => 
                    e.id === evaluationId ? {...e, is_deleted: false} : e
                );

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                updateStats();
                renderEvaluationsTable();
                loadDeletedEvaluationsList();
                hideLoading();

                alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
            }
        }

        // ==================== Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ====================
        async function viewEvaluation(evaluationId) {
            showLoading();
            
            try {
                const evaluation = allEvaluations.find(e => e.id === evaluationId);
                if (!evaluation) {
                    showError('Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                const evaluatorName = evaluation.evaluator?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const question = allQuestions.find(q => q.id === evaluation.question_id);

                const modalContent = `
                    <div style="padding: 20px; color: var(--admin-color);">
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 15px;">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employee?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                                <div><strong>Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…:</strong> ${evaluatorName}</div>
                                <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${getBranchName(employee?.branch)}</div>
                                <div><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> ${getRoleName(employee?.role_id)}</div>
                                <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(evaluation.created_at)}</div>
                                <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${evaluation.is_deleted ? 
                                    '<span style="color: #c0392b;">Ù…Ø­Ø°ÙˆÙ</span>' : 
                                    (evaluation.status === 'completed' ? 
                                        '<span style="color: #27ae60;">Ù…ÙƒØªÙ…Ù„</span>' : 
                                        '<span style="color: #e67e22;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>')
                                }</div>
                            </div>
                        </div>

                        <div style="background: #e8f4f8; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 15px;">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
                            <div style="margin-bottom: 20px;">
                                <strong>Ø§Ù„Ø³Ø¤Ø§Ù„:</strong>
                                <p style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                                    ${question?.question_text || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 30px; align-items: center;">
                                <div>
                                    <strong>Ø§Ù„Ø¯Ø±Ø¬Ø©:</strong>
                                    <h3 style="font-size: 36px; color: ${getScoreColor(evaluation.score)}; margin-top: 10px;">
                                        ${evaluation.score || 0} / 10
                                    </h3>
                                </div>
                                <div style="flex: 1;">
                                    <strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:</strong>
                                    <p style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                                        ${evaluation.comment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                            <button onclick="editEvaluation('${evaluationId}')" style="padding: 12px 25px; background: var(--admin-accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                            </button>
                            <button onclick="closeModal()" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modalTitle').textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('actionModal').style.display = 'flex';
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
            }
        }

        async function editEvaluation(evaluationId) {
            showLoading();
            
            try {
                const evaluation = allEvaluations.find(e => e.id === evaluationId);
                if (!evaluation) {
                    showError('Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                const question = allQuestions.find(q => q.id === evaluation.question_id);

                const modalContent = `
                    <div style="padding: 20px; color: var(--admin-color);">
                        <h3 style="margin-bottom: 25px; color: var(--admin-color);">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${employee?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                                <div><strong>Ø§Ù„Ø³Ø¤Ø§Ù„:</strong> ${question?.question_text || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                            </div>
                        </div>

                        <div style="background: #e8f4f8; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ’¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <label class="form-label">Ø§Ù„Ø¯Ø±Ø¬Ø© (0-10):</label>
                                <input type="number" id="editScore" min="0" max="10" value="${evaluation.score || 0}" 
                                       class="filter-select" style="width: 100%;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label class="form-label">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:</label>
                                <textarea id="editComment" class="filter-select" style="width: 100%; height: 100px; resize: vertical;">${evaluation.comment || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                                <select id="editStatus" class="filter-select" style="width: 100%;">
                                    <option value="pending" ${evaluation.status === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
                                    <option value="completed" ${evaluation.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                            <button onclick="saveEvaluationChanges('${evaluationId}')" style="padding: 12px 25px; background: var(--admin-accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                            <button onclick="closeModal()" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('actionModal').style.display = 'flex';
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
            }
        }

        async function saveEvaluationChanges(evaluationId) {
            const score = parseInt(document.getElementById('editScore').value);
            const comment = document.getElementById('editComment').value;
            const status = document.getElementById('editStatus').value;

            if (isNaN(score) || score < 0 || score > 10) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø© ØµØ­ÙŠØ­Ø© Ø¨ÙŠÙ† 0 Ùˆ 10');
                return;
            }

            showLoading();

            try {
                const { error } = await supabase
                    .from('evaluation_results')
                    .update({
                        score: score,
                        comment: comment,
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', evaluationId);

                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const evalIndex = allEvaluations.findIndex(e => e.id === evaluationId);
                if (evalIndex !== -1) {
                    allEvaluations[evalIndex] = {
                        ...allEvaluations[evalIndex],
                        score: score,
                        comment: comment,
                        status: status,
                        updated_at: new Date().toISOString()
                    };
                }

                filteredEvaluations = filteredEvaluations.map(e => 
                    e.id === evaluationId ? {
                        ...e,
                        score: score,
                        comment: comment,
                        status: status,
                        updated_at: new Date().toISOString()
                    } : e
                );

                renderEvaluationsTable();
                hideLoading();
                closeModal();

                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
            }
        }

        // ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ====================
        async function viewEmployee(employeeId) {
            showLoading();
            
            try {
                const employee = allEmployees.find(e => e.id === employeeId);
                if (!employee) {
                    showError('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const manager = allEmployees.find(e => e.id === employee.manager_id);
                const employeeEvaluations = allEvaluations.filter(e => 
                    e.evaluated_employee_id === employeeId && !e.is_deleted
                );

                // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù
                const totalScore = employeeEvaluations.reduce((sum, eval) => sum + (eval.score || 0), 0);
                const averageScore = employeeEvaluations.length > 0 ? 
                    Math.round((totalScore / (employeeEvaluations.length * 10)) * 100) : 0;

                const modalContent = `
                    <div style="padding: 20px; color: var(--admin-color);">
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 15px;">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${employee.full_name}</div>
                                <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${employee.username}</div>
                                <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${getBranchName(employee.branch)}</div>
                                <div><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> ${getRoleName(employee.role_id)}</div>
                                <div><strong>Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:</strong> ${manager?.full_name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                                <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†:</strong> ${formatDate(employee.hire_date)}</div>
                                <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> ${employee.insurance_status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${employee.is_active ? 
                                    '<span style="color: #27ae60;">Ù†Ø´Ø·</span>' : 
                                    '<span style="color: #e74c3c;">ØºÙŠØ± Ù†Ø´Ø·</span>'
                                }</div>
                            </div>
                        </div>

                        <div style="background: #e8f4f8; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 15px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 36px; font-weight: 800; color: ${getScoreColor(averageScore/10)}">
                                        ${averageScore}%
                                    </div>
                                    <div style="color: #6c757d; font-size: 14px;">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 36px; font-weight: 800; color: var(--admin-info)">
                                        ${employeeEvaluations.length}
                                    </div>
                                    <div style="color: #6c757d; font-size: 14px;">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                            <button onclick="editEmployee('${employeeId}')" style="padding: 12px 25px; background: var(--admin-accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                            <button onclick="closeModal()" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modalTitle').textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('actionModal').style.display = 'flex';
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        async function editEmployee(employeeId) {
            showLoading();
            
            try {
                const employee = allEmployees.find(e => e.id === employeeId);
                if (!employee) {
                    showError('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const managers = allEmployees.filter(e => 
                    [2, 3, 4, 7].includes(e.role_id) && e.id !== employeeId
                );

                const modalContent = `
                    <div style="padding: 20px; color: var(--admin-color);">
                        <h3 style="margin-bottom: 25px; color: var(--admin-color);">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h3>
                        
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                            <h4 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                    <input type="text" id="editEmpFullName" class="filter-select" value="${employee.full_name}" style="width: 100%;">
                                </div>
                                <div>
                                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                                    <input type="text" id="editEmpUsername" class="filter-select" value="${employee.username}" style="width: 100%;">
                                </div>
                                <div>
                                    <label class="form-label">Ø§Ù„Ø¯ÙˆØ±:</label>
                                    <select id="editEmpRoleId" class="filter-select" style="width: 100%;">
                                        <option value="1" ${employee.role_id === 1 ? 'selected' : ''}>Ø£Ø®ØµØ§Ø¦ÙŠ Ù…ÙŠØ¯Ø§Ù†ÙŠ</option>
                                        <option value="2" ${employee.role_id === 2 ? 'selected' : ''}>Ù…Ø³Ø¤ÙˆÙ„ ÙØ±ÙŠÙ‚</option>
                                        <option value="3" ${employee.role_id === 3 ? 'selected' : ''}>Ù…Ø¯ÙŠØ± ÙØ±Ø¹</option>
                                        <option value="4" ${employee.role_id === 4 ? 'selected' : ''}>Ù…Ø¯ÙŠØ± Ù†Ø´Ø§Ø·</option>
                                        <option value="5" ${employee.role_id === 5 ? 'selected' : ''}>Ø¥Ø¯Ø§Ø±ÙŠ</option>
                                        <option value="6" ${employee.role_id === 6 ? 'selected' : ''}>Ù…Ø±ÙƒØ² Ø±Ø¦ÙŠØ³ÙŠ</option>
                                        <option value="7" ${employee.role_id === 7 ? 'selected' : ''}>Ù…Ø³Ø¦ÙˆÙ„ Ù†Ø¸Ø§Ù…</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Ø§Ù„ÙØ±Ø¹:</label>
                                    <select id="editEmpBranch" class="filter-select" style="width: 100%;">
                                        <option value="ÙØ±Ø¹ Ø£Ø¨Ùˆ Ø§Ù„Ù…Ø·Ø§Ù…ÙŠØ±" ${employee.branch === 'ÙØ±Ø¹ Ø£Ø¨Ùˆ Ø§Ù„Ù…Ø·Ø§Ù…ÙŠØ±' ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø§Ù„Ù…Ø·Ø§Ù…ÙŠØ±</option>
                                        <option value="ÙØ±Ø¹ Ø£Ø³ÙŠÙˆØ·" ${employee.branch === 'ÙØ±Ø¹ Ø£Ø³ÙŠÙˆØ·' ? 'selected' : ''}>Ø£Ø³ÙŠÙˆØ·</option>
                                        <option value="ÙØ±Ø¹ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©" ${employee.branch === 'ÙØ±Ø¹ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©' ? 'selected' : ''}>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
                                        <option value="ÙØ±Ø¹ Ø§Ù„Ø£Ù‚ØµØ±" ${employee.branch === 'ÙØ±Ø¹ Ø§Ù„Ø£Ù‚ØµØ±' ? 'selected' : ''}>Ø§Ù„Ø£Ù‚ØµØ±</option>
                                        <option value="ÙØ±Ø¹ Ø§Ù„Ù…Ù†ÙŠØ§" ${employee.branch === 'ÙØ±Ø¹ Ø§Ù„Ù…Ù†ÙŠØ§' ? 'selected' : ''}>Ø§Ù„Ù…Ù†ÙŠØ§</option>
                                        <option value="ÙØ±Ø¹ Ø³ÙˆÙ‡Ø§Ø¬" ${employee.branch === 'ÙØ±Ø¹ Ø³ÙˆÙ‡Ø§Ø¬' ? 'selected' : ''}>Ø³ÙˆÙ‡Ø§Ø¬</option>
                                        <option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©" ${employee.branch === 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©' ? 'selected' : ''}>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:</label>
                                    <select id="editEmpManager" class="filter-select" style="width: 100%;">
                                        <option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                                        ${managers.map(m => `
                                            <option value="${m.id}" ${employee.manager_id === m.id ? 'selected' : ''}>
                                                ${m.full_name} (${getRoleName(m.role_id)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</label>
                                    <select id="editEmpInsurance" class="filter-select" style="width: 100%;">
                                        <option value="Ù…Ø¤Ù…Ù†" ${employee.insurance_status === 'Ù…Ø¤Ù…Ù†' ? 'selected' : ''}>Ù…Ø¤Ù…Ù†</option>
                                        <option value="ØºÙŠØ± Ù…Ø¤Ù…Ù†" ${employee.insurance_status === 'ØºÙŠØ± Ù…Ø¤Ù…Ù†' ? 'selected' : ''}>ØºÙŠØ± Ù…Ø¤Ù…Ù†</option>
                                        <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯" ${!employee.insurance_status || employee.insurance_status === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? 'selected' : ''}>ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                    <select id="editEmpActive" class="filter-select" style="width: 100%;">
                                        <option value="true" ${employee.is_active ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                        <option value="false" ${!employee.is_active ? 'selected' : ''}>ØºÙŠØ± Ù†Ø´Ø·</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†:</label>
                                    <input type="date" id="editEmpHireDate" class="filter-select" value="${employee.hire_date || ''}" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                            <button onclick="saveEmployeeChanges('${employeeId}')" style="padding: 12px 25px; background: var(--admin-accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                            </button>
                            <button onclick="closeModal()" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù';
                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('actionModal').style.display = 'flex';
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
            }
        }

        async function saveEmployeeChanges(employeeId) {
            const fullName = document.getElementById('editEmpFullName').value.trim();
            const username = document.getElementById('editEmpUsername').value.trim();
            const roleId = parseInt(document.getElementById('editEmpRoleId').value);
            const branch = document.getElementById('editEmpBranch').value;
            const managerId = document.getElementById('editEmpManager').value || null;
            const insuranceStatus = document.getElementById('editEmpInsurance').value;
            const isActive = document.getElementById('editEmpActive').value === 'true';
            const hireDate = document.getElementById('editEmpHireDate').value;

            if (!fullName || !username) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }

            showLoading();

            try {
                const { error } = await supabase
                    .from('employees')
                    .update({
                        full_name: fullName,
                        username: username,
                        role_id: roleId,
                        branch: branch,
                        manager_id: managerId,
                        insurance_status: insuranceStatus,
                        is_active: isActive,
                        hire_date: hireDate || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', employeeId);

                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const empIndex = allEmployees.findIndex(e => e.id === employeeId);
                if (empIndex !== -1) {
                    allEmployees[empIndex] = {
                        ...allEmployees[empIndex],
                        full_name: fullName,
                        username: username,
                        role_id: roleId,
                        branch: branch,
                        manager_id: managerId,
                        insurance_status: insuranceStatus,
                        is_active: isActive,
                        hire_date: hireDate || null
                    };
                }

                filteredEmployees = filteredEmployees.map(e => 
                    e.id === employeeId ? {
                        ...e,
                        full_name: fullName,
                        username: username,
                        role_id: roleId,
                        branch: branch,
                        manager_id: managerId,
                        insurance_status: insuranceStatus,
                        is_active: isActive,
                        hire_date: hireDate || null
                    } : e
                );

                renderEmployeesTable();
                updateFilters();
                hideLoading();
                closeModal();

                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù');
            }
        }

        // ==================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ====================
        async function generateEmployeeReport() {
            const employeeId = document.getElementById('reportEmployee').value;
            if (!employeeId) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            showLoading();

            try {
                const employee = allEmployees.find(e => e.id === employeeId);
                if (!employee) {
                    showError('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const employeeEvaluations = allEvaluations.filter(e => 
                    e.evaluated_employee_id === employeeId && !e.is_deleted
                );

                if (employeeEvaluations.length === 0) {
                    alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù');
                    hideLoading();
                    return;
                }

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const totalScore = employeeEvaluations.reduce((sum, eval) => sum + (eval.score || 0), 0);
                const averageScore = Math.round((totalScore / (employeeEvaluations.length * 10)) * 100);
                const grade = getGradeFromScore(averageScore);
                const scoreColor = getScoreColor(averageScore/10);

                // Ø¬Ù…Ø¹ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙƒÙ„ Ø³Ø¤Ø§Ù„
                const evaluationsByQuestion = {};
                employeeEvaluations.forEach(eval => {
                    const question = allQuestions.find(q => q.id === eval.question_id);
                    if (question) {
                        if (!evaluationsByQuestion[question.id]) {
                            evaluationsByQuestion[question.id] = {
                                question: question.question_text,
                                category: question.category,
                                scores: [],
                                comments: []
                            };
                        }
                        evaluationsByQuestion[question.id].scores.push(eval.score || 0);
                        if (eval.comment) {
                            evaluationsByQuestion[question.id].comments.push(eval.comment);
                        }
                    }
                });

                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                let questionsHtml = '';
                Object.values(evaluationsByQuestion).forEach((item, index) => {
                    const avgQuestionScore = item.scores.reduce((a, b) => a + b, 0) / item.scores.length;
                    questionsHtml += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-right: 4px solid var(--admin-accent);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: var(--admin-color);">${index + 1}. ${item.question}</strong>
                                <span style="font-weight: bold; color: ${getScoreColor(avgQuestionScore)}">${avgQuestionScore.toFixed(1)}/10</span>
                            </div>
                            <div style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">
                                <strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${item.category}
                            </div>
                            ${item.comments.length > 0 ? `
                                <div style="color: #6c757d; font-size: 14px;">
                                    <strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª:</strong>
                                    <ul style="margin-right: 20px; margin-top: 5px;">
                                        ${item.comments.map(comment => `<li>${comment}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù - ${employee.full_name}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Arial, sans-serif; 
                                direction: rtl; 
                                padding: 30px; 
                                margin: 0; 
                                color: #2c3e50; 
                                line-height: 1.6;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 40px; 
                                padding-bottom: 20px; 
                                border-bottom: 3px solid #1abc9c; 
                            }
                            .info-grid { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 20px; 
                                margin: 30px 0; 
                                background: #f8f9fa; 
                                padding: 25px; 
                                border-radius: 15px; 
                            }
                            .summary-box { 
                                text-align: center; 
                                margin: 30px 0; 
                                padding: 30px; 
                                border-radius: 15px; 
                                background: #e8f4f8; 
                                border: 2px solid ${scoreColor};
                            }
                            .summary-score { 
                                font-size: 56px; 
                                font-weight: 800; 
                                color: ${scoreColor}; 
                            }
                            .summary-grade { 
                                font-size: 28px; 
                                color: ${scoreColor}; 
                                font-weight: 700; 
                                margin-top: 10px;
                            }
                            .evaluation-details { 
                                margin-top: 40px; 
                            }
                            .question-item { 
                                margin-bottom: 20px; 
                                padding: 15px; 
                                background: #f8f9fa; 
                                border-radius: 10px; 
                                border-right: 4px solid #1abc9c; 
                            }
                            .footer { 
                                text-align: center; 
                                margin-top: 50px; 
                                padding-top: 20px; 
                                border-top: 2px solid #e9ecef; 
                                color: #6c757d; 
                                font-size: 14px; 
                            }
                            .no-print { display: block; }
                            @media print {
                                .no-print { display: none; }
                                body { padding: 20px; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù</h1>
                            <p style="color: #6c757d;">ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ± - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
                        </div>

                        <div class="info-grid">
                            <div><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${employee.full_name}</div>
                            <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${employee.username}</div>
                            <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${getBranchName(employee.branch)}</div>
                            <div><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> ${getRoleName(employee.role_id)}</div>
                            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†:</strong> ${formatDate(employee.hire_date)}</div>
                            <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> ${employee.insurance_status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:</strong> ${employeeEvaluations.length}</div>
                            <div><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${new Date().toLocaleDateString('ar-SA')}</div>
                        </div>

                        <div class="summary-box">
                            <h3 style="color: #2c3e50; margin-bottom: 20px;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</h3>
                            <p class="summary-score">${averageScore}%</p>
                            <p class="summary-grade">${grade}</p>
                        </div>

                        <div class="evaluation-details">
                            <h3 style="color: #2c3e50; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
                            ${questionsHtml}
                        </div>
                        
                        <div class="footer">
                            <p>Â© ${new Date().getFullYear()} ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ± - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
                            <p>ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… - ${currentUser.full_name}</p>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleString('ar-SA')}</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 40px;">
                            <button onclick="window.print()" style="padding: 12px 30px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button onclick="window.close()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        }

        async function printFullEvaluation() {
            const evaluationId = document.getElementById('printEvaluation').value;
            if (!evaluationId) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            showLoading();

            try {
                const evaluation = allEvaluations.find(e => e.id === evaluationId);
                if (!evaluation) {
                    showError('Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const employee = allEmployees.find(e => e.id === evaluation.evaluated_employee_id);
                const evaluatorName = evaluation.evaluator?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const question = allQuestions.find(q => q.id === evaluation.question_id);

                if (!employee || !question) {
                    showError('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
                    hideLoading();
                    return;
                }

                const score = evaluation.score || 0;
                const scorePercent = score * 10;
                const grade = getGradeFromScore(scorePercent);
                const scoreColor = getScoreColor(score);

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… - ${employee.full_name}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Arial, sans-serif; 
                                direction: rtl; 
                                padding: 30px; 
                                margin: 0; 
                                color: #2c3e50; 
                                line-height: 1.6;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 40px; 
                                padding-bottom: 20px; 
                                border-bottom: 3px solid #1abc9c; 
                            }
                            .info-grid { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 20px; 
                                margin: 30px 0; 
                                background: #f8f9fa; 
                                padding: 25px; 
                                border-radius: 15px; 
                            }
                            .evaluation-details { 
                                margin: 30px 0; 
                                padding: 25px; 
                                background: #e8f4f8; 
                                border-radius: 15px; 
                                border: 2px solid ${scoreColor};
                            }
                            .score-display { 
                                text-align: center; 
                                font-size: 48px; 
                                font-weight: 800; 
                                color: ${scoreColor}; 
                            }
                            .score-grade { 
                                text-align: center; 
                                font-size: 24px; 
                                color: ${scoreColor}; 
                                font-weight: 700; 
                                margin-top: 10px;
                            }
                            .question-box { 
                                margin: 25px 0; 
                                padding: 20px; 
                                background: white; 
                                border-radius: 10px; 
                                border-right: 4px solid #3498db; 
                            }
                            .comment-box { 
                                margin: 25px 0; 
                                padding: 20px; 
                                background: white; 
                                border-radius: 10px; 
                                border-right: 4px solid #9b59b6; 
                            }
                            .footer { 
                                text-align: center; 
                                margin-top: 50px; 
                                padding-top: 20px; 
                                border-top: 2px solid #e9ecef; 
                                color: #6c757d; 
                                font-size: 14px; 
                            }
                            .no-print { display: block; }
                            @media print {
                                .no-print { display: none; }
                                body { padding: 20px; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ“„ ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡</h1>
                            <p style="color: #6c757d;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„ - ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ±</p>
                        </div>

                        <div class="info-grid">
                            <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ù‚ÙŠÙ‘ÙÙ…:</strong> ${employee.full_name}</div>
                            <div><strong>Ø§Ù„Ù…Ù‚ÙŠÙ‘ÙÙ…:</strong> ${evaluatorName}</div>
                            <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${getBranchName(employee.branch)}</div>
                            <div><strong>Ø§Ù„Ø¯ÙˆØ±:</strong> ${getRoleName(employee.role_id)}</div>
                            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${formatDate(evaluation.created_at)}</div>
                            <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${evaluation.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…'}</div>
                        </div>

                        <div class="evaluation-details">
                            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
                            <p class="score-display">${score} / 10</p>
                            <p class="score-grade">(${scorePercent}%) - ${grade}</p>
                        </div>

                        <div class="question-box">
                            <h4 style="color: #3498db; margin-bottom: 15px;">ğŸ“ Ø§Ù„Ø³Ø¤Ø§Ù„:</h4>
                            <p style="font-size: 16px; line-height: 1.8;">${question.question_text}</p>
                            <div style="margin-top: 15px; color: #6c757d;">
                                <strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${question.category}
                            </div>
                        </div>

                        <div class="comment-box">
                            <h4 style="color: #9b59b6; margin-bottom: 15px;">ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…:</h4>
                            <p style="font-size: 16px; line-height: 1.8; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                ${evaluation.comment || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚'}
                            </p>
                        </div>

                        <div class="info-grid" style="margin-top: 30px;">
                            <div>
                                <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…:</strong>
                                <div style="height: 60px; border-bottom: 1px solid #ccc; margin-top: 10px;"></div>
                            </div>
                            <div>
                                <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„:</strong>
                                <div style="height: 60px; border-bottom: 1px solid #ccc; margin-top: 10px;"></div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>Â© ${new Date().getFullYear()} ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ± - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
                            <p>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… - ${currentUser.full_name}</p>
                            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-SA')}</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 40px;">
                            <button onclick="window.print()" style="padding: 12px 30px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button onclick="window.close()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
            }
        }

        function generateStatsReport() {
            const reportType = document.getElementById('reportType').value;
            
            showLoading();

            try {
                let reportData = {};
                let reportTitle = '';
                let reportContent = '';

                switch(reportType) {
                    case 'summary':
                        reportTitle = 'Ù…Ù„Ø®Øµ Ø¹Ø§Ù… Ù„Ù„Ù†Ø¸Ø§Ù…';
                        reportData = getSummaryReport();
                        break;
                    case 'branches':
                        reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙˆØ¹';
                        reportData = getBranchesReport();
                        break;
                    case 'roles':
                        reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±';
                        reportData = getRolesReport();
                        break;
                    case 'monthly':
                        reportTitle = 'ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ';
                        reportData = getMonthlyReport();
                        break;
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>${reportTitle}</title>
                        <style>
                            body { font-family: 'Segoe UI', Arial, sans-serif; direction: rtl; padding: 30px; margin: 0; color: #2c3e50; }
                            .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #1abc9c; }
                            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
                            .stat-item { background: #f8f9fa; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #e9ecef; }
                            .stat-number { font-size: 28px; font-weight: 800; color: var(--admin-color); margin-bottom: 8px; }
                            .stat-label { font-size: 13px; color: #6c757d; font-weight: 600; }
                            .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            .report-table th, .report-table td { border: 1px solid #ddd; padding: 12px; text-align: right; }
                            .report-table th { background-color: #2c3e50; color: white; }
                            .footer { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 2px solid #e9ecef; color: #6c757d; font-size: 14px; }
                            .no-print { display: block; }
                            @media print { .no-print { display: none; } body { padding: 20px; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ“ˆ ${reportTitle}</h1>
                            <p style="color: #6c757d;">ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ± - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
                            <p style="color: #6c757d;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>

                        ${reportContent}

                        <div class="footer">
                            <p>Â© ${new Date().getFullYear()} ÙƒØ§Ø±ÙŠØªØ§Ø³ Ù…ØµØ± - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„</p>
                            <p>ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… - ${currentUser.full_name}</p>
                        </div>

                        <div class="no-print" style="text-align: center; margin-top: 40px;">
                            <button onclick="window.print()" style="padding: 12px 30px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button onclick="window.close()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;">
                                Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                hideLoading();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ:', error);
                hideLoading();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ');
            }
        }

        function getSummaryReport() {
            const activeEvaluations = allEvaluations.filter(e => !e.is_deleted);
            const completedEvals = activeEvaluations.filter(e => e.status === 'completed').length;
            const pendingEvals = activeEvaluations.filter(e => e.status === 'pending').length;
            
            // Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
            const totalScore = activeEvaluations.reduce((sum, eval) => sum + (eval.score || 0), 0);
            const avgScore = activeEvaluations.length > 0 ? 
                (totalScore / activeEvaluations.length).toFixed(1) : 0;
            
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
            const scoreDistribution = {
                Ù…Ù…ØªØ§Ø²: activeEvaluations.filter(e => (e.score || 0) >= 9).length,
                Ø¬ÙŠØ¯: activeEvaluations.filter(e => (e.score || 0) >= 7 && (e.score || 0) < 9).length,
                Ù…ØªÙˆØ³Ø·: activeEvaluations.filter(e => (e.score || 0) >= 5 && (e.score || 0) < 7).length,
                Ø¶Ø¹ÙŠÙ: activeEvaluations.filter(e => (e.score || 0) < 5).length
            };

            return `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${systemStats.totalEmployees}</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${systemStats.activeEmployees}</div>
                        <div class="stat-label">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${systemStats.totalEvaluations}</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${completedEvals}</div>
                        <div class="stat-label">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${pendingEvals}</div>
                        <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${systemStats.deletedCount}</div>
                        <div class="stat-label">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø­Ø°ÙˆÙØ©</div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…</th>
                                <th>Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</th>
                                <th>Ø£Ù‚Ù„ Ø¯Ø±Ø¬Ø©</th>
                                <th>Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>${avgScore}/10</strong></td>
                                <td><strong>${Math.max(...activeEvaluations.map(e => e.score || 0))}/10</strong></td>
                                <td><strong>${Math.min(...activeEvaluations.filter(e => e.score !== null).map(e => e.score || 0))}/10</strong></td>
                                <td><strong>${calculateStandardDeviation(activeEvaluations.map(e => e.score || 0)).toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                                <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                <th>Ø§Ù„Ù†Ø·Ø§Ù‚</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(scoreDistribution).map(([grade, count]) => `
                                <tr>
                                    <td><strong>${grade}</strong></td>
                                    <td>${count}</td>
                                    <td>${activeEvaluations.length > 0 ? ((count / activeEvaluations.length) * 100).toFixed(1) : 0}%</td>
                                    <td>${grade === 'Ù…Ù…ØªØ§Ø²' ? '9-10' : grade === 'Ø¬ÙŠØ¯' ? '7-8.9' : grade === 'Ù…ØªÙˆØ³Ø·' ? '5-6.9' : '0-4.9'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getBranchesReport() {
            const branches = [...new Set(allEmployees.map(emp => emp.branch).filter(Boolean))];
            
            let tableRows = '';
            branches.forEach(branch => {
                const branchEmployees = allEmployees.filter(emp => emp.branch === branch);
                const branchEvaluations = allEvaluations.filter(eval => {
                    const emp = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                    return emp && emp.branch === branch && !eval.is_deleted;
                });
                
                const completedEvals = branchEvaluations.filter(e => e.status === 'completed').length;
                const avgScore = branchEvaluations.length > 0 ? 
                    (branchEvaluations.reduce((sum, eval) => sum + (eval.score || 0), 0) / branchEvaluations.length).toFixed(1) : 0;
                
                tableRows += `
                    <tr>
                        <td><strong>${getBranchName(branch)}</strong></td>
                        <td>${branchEmployees.length}</td>
                        <td>${branchEvaluations.length}</td>
                        <td>${completedEvals}</td>
                        <td><strong>${avgScore}/10</strong></td>
                        <td>${branchEvaluations.length > 0 ? ((completedEvals / branchEvaluations.length) * 100).toFixed(1) : 0}%</td>
                    </tr>
                `;
            });

            return `
                <div style="margin-top: 30px;">
                    <h3 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ¢ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±ÙˆØ¹</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th>
                                <th>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getRolesReport() {
            const roles = [...new Set(allEmployees.map(emp => emp.role_id))];
            
            let tableRows = '';
            roles.forEach(roleId => {
                const roleEmployees = allEmployees.filter(emp => emp.role_id === roleId);
                const roleEvaluations = allEvaluations.filter(eval => {
                    const emp = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                    return emp && emp.role_id === roleId && !eval.is_deleted;
                });
                
                const completedEvals = roleEvaluations.filter(e => e.status === 'completed').length;
                const avgScore = roleEvaluations.length > 0 ? 
                    (roleEvaluations.reduce((sum, eval) => sum + (eval.score || 0), 0) / roleEvaluations.length).toFixed(1) : 0;
                
                tableRows += `
                    <tr>
                        <td><strong>${getRoleName(roleId)}</strong></td>
                        <td>${roleEmployees.length}</td>
                        <td>${roleEvaluations.length}</td>
                        <td>${completedEvals}</td>
                        <td><strong>${avgScore}/10</strong></td>
                        <td>${roleEvaluations.length > 0 ? ((completedEvals / roleEvaluations.length) * 100).toFixed(1) : 0}%</td>
                    </tr>
                `;
            });

            return `
                <div style="margin-top: 30px;">
                    <h3 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th>
                                <th>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getMonthlyReport() {
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            const monthlyData = {};
            
            allEvaluations.filter(e => !e.is_deleted).forEach(eval => {
                const date = new Date(eval.created_at);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        evaluations: 0,
                        completed: 0,
                        totalScore: 0,
                        employees: new Set()
                    };
                }
                
                monthlyData[monthKey].evaluations++;
                monthlyData[monthKey].totalScore += eval.score || 0;
                
                if (eval.status === 'completed') {
                    monthlyData[monthKey].completed++;
                }
                
                const emp = allEmployees.find(e => e.id === eval.evaluated_employee_id);
                if (emp) {
                    monthlyData[monthKey].employees.add(emp.id);
                }
            });

            // ÙØ±Ø² Ø§Ù„Ø£Ø´Ù‡Ø±
            const sortedMonths = Object.keys(monthlyData).sort().reverse().slice(0, 12); // Ø¢Ø®Ø± 12 Ø´Ù‡Ø±
            
            let tableRows = '';
            sortedMonths.forEach(monthKey => {
                const data = monthlyData[monthKey];
                const avgScore = data.evaluations > 0 ? (data.totalScore / data.evaluations).toFixed(1) : 0;
                const completionRate = data.evaluations > 0 ? ((data.completed / data.evaluations) * 100).toFixed(1) : 0;
                const uniqueEmployees = data.employees.size;
                
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, month - 1).toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' });
                
                tableRows += `
                    <tr>
                        <td><strong>${monthName}</strong></td>
                        <td>${uniqueEmployees}</td>
                        <td>${data.evaluations}</td>
                        <td>${data.completed}</td>
                        <td><strong>${avgScore}/10</strong></td>
                        <td>${completionRate}%</td>
                    </tr>
                `;
            });

            return `
                <div style="margin-top: 30px;">
                    <h3 style="color: var(--admin-color); margin-bottom: 20px;">ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø¢Ø®Ø± 12 Ø´Ù‡Ø±)</h3>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø´Ù‡Ø±</th>
                                <th>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</th>
                                <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th>
                                <th>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function calculateStandardDeviation(numbers) {
            if (numbers.length === 0) return 0;
            const mean = numbers.reduce((a, b) => a + b, 0) / numbers.length;
            const squaredDiffs = numbers.map(n => Math.pow(n - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / numbers.length;
            return Math.sqrt(variance);
        }

        function getGradeFromScore(percentage) {
            if (percentage >= 90) return 'Ù…Ù…ØªØ§Ø²';
            if (percentage >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
            if (percentage >= 70) return 'Ø¬ÙŠØ¯';
            if (percentage >= 60) return 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
            return 'Ø¶Ø¹ÙŠÙ';
        }

        // ==================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… ====================
        function refreshSystem() {
            loadAllData();
            alert('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
        }

        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('caritas_user');
                window.location.href = 'index.html';
            }
        }

        // ==================== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                border-radius: 10px;
                text-align: center;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateY(-100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(-100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadAllData();
            }
        }, 5 * 60 * 1000);

    </script>
</body>
</html>