<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- âœ… Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹ - Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ 2025</title>
    
    <!-- âœ… ØªØ­Ù…ÙŠÙ„ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #0ea5e9;
            --accent-color: #8b5cf6;
            --light-bg: #f8fafc;
            --dark-text: #1e293b;
            --light-text: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-text);
            direction: rtl;
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            color: var(--primary-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
        }
        .user-details h2 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .user-details p {
            font-size: 16px;
            color: var(--light-text);
        }
        .logout-btn {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }
        .main-container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        .sidebar-section {
            margin-bottom: 30px;
        }
        .sidebar-title {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e0f2fe;
            font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #bae6fd;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 14px;
            color: var(--light-text);
        }
        .employees-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }
        .employee-item {
            padding: 20px;
            margin-bottom: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
        }
        .employee-item:hover,
        .employee-item.active {
            border-color: var(--primary-color);
            background: #eff6ff;
        }
        .employee-name {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 8px;
            font-size: 18px;
        }
        .evaluation-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
            font-size: 16px;
        }
        .alert.show {
            display: block;
        }
        .alert-success { background: #d1fae5; color: #065f46; border: 2px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #fecaca; }
        .question-card {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        .question-number {
            background: var(--primary-color);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rating-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .rating-option {
            padding: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
        }
        .rating-option:hover,
        .rating-option.selected {
            border-color: var(--primary-color);
            background: #e8f4fd;
        }
        .comment-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 3px solid #f0f0f0;
        }
        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            min-width: 180px;
        }
        .btn-save { background: var(--info-color); color: white; }
        .btn-submit { background: var(--success-color); color: white; }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { order: 2; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; text-align: center; }
            .controls { flex-direction: column; gap: 15px; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-details">
                <h2 id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <p id="userRole">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹ - ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalEmployees">0</div>
                        <div class="stat-label">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedEvaluations">0</div>
                        <div class="stat-label">ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ù…</div>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h3>
                <ul class="employees-list" id="employeesList">
                    <li style="text-align: center; padding: 30px; color: #666;">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </li>
                </ul>
            </div>
        </aside>
        <main class="evaluation-area">
            <div id="alertBox" class="alert"></div>
            <div class="evaluation-header" style="margin-bottom: 30px;">
                <div>
                    <h3 id="selectedEmployeeName">Ø§Ø®ØªØ± Ù…ÙˆØ¸ÙØ§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                    <p id="selectedEmployeeInfo" style="color: var(--light-text);"></p>
                </div>
                <div id="evaluationStatus" style="color: var(--primary-color); font-weight: 600;"></div>
            </div>
            <div id="evaluationForm" style="display: none;">
                <div class="questions-container">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px;">ğŸ“ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ 2025</h4>
                    <div id="questionsContainer">
                        <!-- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ -->
                    </div>
                    <div class="controls">
                        <button class="btn btn-save" id="saveBtn" onclick="saveEvaluation()" disabled>
                            ğŸ’¾ Ø­ÙØ¸ Ù…Ø¤Ù‚Øª
                        </button>
                        <button class="btn btn-submit" id="submitBtn" onclick="submitEvaluation()" disabled>
                            âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                        </button>
                    </div>
                </div>
            </div>
            <div id="noEmployeesMessage" style="text-align: center; padding: 60px; color: #666; display: none;">
                <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† ØªØ­Øª Ø¥Ø´Ø±Ø§ÙÙƒ</h3>
            </div>
        </main>
    </div>

    <script>
        // ==================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====================
        const SUPABASE_URL = 'https://pzsxhypigslcvduegvpa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6c3hoeXBpZ3NsY3ZkdWVndnBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTMxOTQsImV4cCI6MjA4MTA2OTE5NH0.0LC452nPLSywGh1mKxNQedm3M_yWZ4srck-gK67iZag';

        let supabaseClient;
        let currentUser = null;
        let selectedEmployee = null;
        let myEmployees = [];
        let questions = [];
        let evaluations = {};
        let currentCycle = null;

        const RATING_OPTIONS = [
            { score: 10, label: 'Ù…Ù…ØªØ§Ø²', desc: 'Ø£Ø¯Ø§Ø¡ ÙŠÙÙˆÙ‚ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª' },
            { score: 8, label: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', desc: 'Ø£Ø¯Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨' },
            { score: 6, label: 'Ø¬ÙŠØ¯', desc: 'Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„' },
            { score: 4, label: 'ÙŠØ­ØªØ§Ø¬ Ù„ØªØ­Ø³ÙŠÙ†', desc: 'Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨' },
            { score: 2, label: 'Ø¶Ø¹ÙŠÙ', desc: 'Ø£Ø¯Ø§Ø¡ Ø¶Ø¹ÙŠÙ Ø¬Ø¯Ø§Ù‹' }
        ];

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (ÙŠØ¹Ù…Ù„ 100%) ====================
        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                try {
                    localStorage.removeItem('caritas_user');
                } catch (e) {}
                window.location.replace('index.html');
            }
        }

        // ==================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹...');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            try {
                currentUser = JSON.parse(localStorage.getItem('caritas_user'));
                if (!currentUser || currentUser.role_id !== 3) {
                    window.location.href = 'index.html';
                    return;
                }
            } catch (e) {
                window.location.href = 'index.html';
                return;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('userName').textContent = currentUser.full_name;
            document.getElementById('userRole').textContent = `Ù…Ø¯ÙŠØ± ÙØ±Ø¹ - ${currentUser.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            document.getElementById('userAvatar').textContent = currentUser.full_name.charAt(0);

            // ØªÙ‡ÙŠØ¦Ø© Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL.trim(), SUPABASE_KEY.trim());

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await loadData();
        });

        async function loadData() {
            try {
                // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹
                const {  empData, error: empError } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('branch', currentUser.branch)
                    .eq('is_active', true)
                    .not('role_id', 'eq', 3)
                    .not('id', 'eq', currentUser.id)
                    .order('full_name');
                myEmployees = empError ? [] : empData || [];

                // âœ… Ø¬Ù„Ø¨ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø´Ø·Ø©
                const {  cycleData, error: cycleErr } = await supabaseClient
                    .from('evaluation_cycles')
                    .select('*')
                    .eq('is_active', true)
                    .single();
                currentCycle = !cycleErr && cycleData ? cycleData : null;

                // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©!)
                const {  qData, error: qError } = await supabaseClient
                    .from('evaluation_questions')
                    .select('*')
                    .eq('is_active', true)
                    .order('level_id, question_order');
                questions = qError ? [] : qData || [];
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${questions.length} Ø³Ø¤Ø§Ù„`);

                // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                await loadEvaluations();

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                renderEmployeesList();
                updateStats();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        async function loadEvaluations() {
            if (!myEmployees.length || !currentCycle) {
                evaluations = {};
                return;
            }
            const empIds = myEmployees.map(e => e.id);
            const { data, error } = await supabaseClient
                .from('evaluation_results')
                .select('*')
                .eq('cycle_id', currentCycle.id)
                .in('evaluated_employee_id', empIds);

            evaluations = {};
            if (!error && data) {
                data.forEach(rec => {
                    if (!evaluations[rec.evaluated_employee_id]) {
                        evaluations[rec.evaluated_employee_id] = {};
                    }
                    evaluations[rec.evaluated_employee_id][rec.question_id] = rec;
                });
            }
        }

        function renderEmployeesList() {
            const container = document.getElementById('employeesList');
            const noMsg = document.getElementById('noEmployeesMessage');
            if (myEmployees.length === 0) {
                container.innerHTML = '<li style="text-align:center;padding:30px;color:#666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</li>';
                noMsg.style.display = 'block';
                return;
            }
            noMsg.style.display = 'none';
            container.innerHTML = '';
            myEmployees.forEach(emp => {
                const li = document.createElement('li');
                li.className = 'employee-item';
                li.innerHTML = `<div class="employee-name">${emp.full_name}</div>
                                <div style="font-size:14px;color:#666;">${getRoleName(emp.role_id)}</div>`;
                li.onclick = () => selectEmployee(emp);
                container.appendChild(li);
            });
            document.getElementById('totalEmployees').textContent = myEmployees.length;
        }

        function selectEmployee(employee) {
            selectedEmployee = employee;
            document.querySelectorAll('.employee-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('selectedEmployeeName').textContent = employee.full_name;
            document.getElementById('selectedEmployeeInfo').textContent = 
                `${employee.branch} â€¢ ${getRoleName(employee.role_id)}`;
            document.getElementById('evaluationForm').style.display = 'block';

            renderQuestions();
            updateStatus();
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            const level = getEvaluationLevel(selectedEmployee);
            const empQuestions = questions.filter(q => q.level_id === level);
            
            if (empQuestions.length === 0) {
                container.innerHTML = '<p style="color:#666;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p>';
                return;
            }

            container.innerHTML = '';
            empQuestions.forEach((q, idx) => {
                const evalData = evaluations[selectedEmployee.id]?.[q.id];
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <div class="question-number">${idx + 1}</div>
                        <span style="background:#e0f2fe;color:#0369a1;padding:4px 12px;border-radius:15px;font-size:14px;">
                            ${q.category}
                        </span>
                    </div>
                    <div style="margin-bottom:15px;">${q.question_text}</div>
                    <div class="rating-options">
                        ${RATING_OPTIONS.map(opt => `
                            <div class="rating-option" 
                                 data-score="${opt.score}"
                                 onclick="selectRating('${q.id}', ${opt.score})"
                                 style="${evalData?.score == opt.score ? 'border-color:var(--primary-color); background:#dbeafe;' : ''}">
                                <div style="font-weight:600;">${opt.label}</div>
                                <div style="font-size:13px;color:#666;">(${opt.score}/10)</div>
                                <div style="font-size:12px;color:#999;">${opt.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                    <textarea class="comment-box" 
                              placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                              oninput="updateComment('${q.id}', this.value)"
                              ${evalData?.score ? '' : 'disabled'}>${evalData?.comment || ''}</textarea>
                `;
                container.appendChild(card);
            });

            updateButtons();
        }

        function getEvaluationLevel(emp) {
            if (emp.role_id === 2) return 2; // Ù…Ø³Ø¤ÙˆÙ„ ÙØ±ÙŠÙ‚
            if (emp.role_id === 5) return 4; // Ø¥Ø¯Ø§Ø±ÙŠ
            if (emp.role_id === 1) return 1; // Ø£Ø®ØµØ§Ø¦ÙŠ
            return 1;
        }

        function getRoleName(roleId) {
            const roles = {1:'Ø£Ø®ØµØ§Ø¦ÙŠ Ù…ÙŠØ¯Ø§Ù†ÙŠ',2:'Ù…Ø³Ø¤ÙˆÙ„ ÙØ±ÙŠÙ‚',5:'Ø¥Ø¯Ø§Ø±ÙŠ'};
            return roles[roleId] || 'Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        }

        function selectRating(questionId, score) {
            if (!selectedEmployee) return;
            
            const comment = evaluations[selectedEmployee.id]?.[questionId]?.comment || '';
            
            if (!evaluations[selectedEmployee.id]) {
                evaluations[selectedEmployee.id] = {};
            }
            evaluations[selectedEmployee.id][questionId] = {
                question_id: questionId,
                evaluated_employee_id: selectedEmployee.id,
                evaluator_id: currentUser.id,
                cycle_id: currentCycle?.id,
                score: score,
                comment: comment,
                created_at: new Date().toISOString()
            };
            
            renderQuestions();
            updateStatus();
        }

        function updateComment(questionId, comment) {
            if (selectedEmployee && evaluations[selectedEmployee.id]?.[questionId]) {
                evaluations[selectedEmployee.id][questionId].comment = comment;
            }
        }

        function updateStatus() {
            if (!selectedEmployee) return;
            const level = getEvaluationLevel(selectedEmployee);
            const total = questions.filter(q => q.level_id === level).length;
            const answered = Object.keys(evaluations[selectedEmployee.id] || {}).length;
            const pct = total > 0 ? Math.round((answered / total) * 100) : 0;
            document.getElementById('evaluationStatus').textContent = `Ø§Ù„ØªÙ‚Ø¯Ù…: ${pct}% (${answered}/${total})`;
        }

        function updateButtons() {
            if (!selectedEmployee) {
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('submitBtn').disabled = true;
                return;
            }
            const level = getEvaluationLevel(selectedEmployee);
            const total = questions.filter(q => q.level_id === level).length;
            const answered = Object.keys(evaluations[selectedEmployee.id] || {}).length;
            document.getElementById('saveBtn').disabled = answered === 0;
            document.getElementById('submitBtn').disabled = answered < total;
        }

        async function saveEvaluation() {
            if (!selectedEmployee || !currentCycle) return;
            try {
                const empEvals = evaluations[selectedEmployee.id] || {};
                const evalArray = Object.values(empEvals);
                let success = 0;
                for (const eval of evalArray) {
                    const { error } = await supabaseClient
                        .from('evaluation_results')
                        .upsert(eval, { onConflict: 'cycle_id,evaluated_employee_id,evaluator_id,question_id' });
                    if (!error) success++;
                }
                if (success > 0) {
                    showAlert(`ØªÙ… Ø­ÙØ¸ ${success} Ø¥Ø¬Ø§Ø¨Ø©`, 'success');
                }
                updateStatus();
            } catch (err) {
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error');
            }
        }

        async function submitEvaluation() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
            await saveEvaluation(); // Ø§Ø­ÙØ¸ Ø£ÙˆÙ„Ø§Ù‹
            showAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            setTimeout(() => location.reload(), 1500);
        }

        function updateStats() {
            const completed = myEmployees.filter(emp => {
                const level = getEvaluationLevel(emp);
                const total = questions.filter(q => q.level_id === level).length;
                const answered = Object.keys(evaluations[emp.id] || {}).length;
                return answered === total;
            }).length;
            document.getElementById('completedEvaluations').textContent = completed;
        }

        function showAlert(message, type) {
            const box = document.getElementById('alertBox');
            box.textContent = message;
            box.className = `alert alert-${type} show`;
            setTimeout(() => box.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>