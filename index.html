<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabaseUrl = 'https://pzsxhypigslcvduegvpa.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6c3hoeXBpZ3NsY3ZkdWVndnBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTMxOTQsImV4cCI6MjA4MTA2OTE5NH0.0LC452nPLSywGh1mKxNQedm3M_yWZ4srck-gK67iZag'
  const supabase = createClient(supabaseUrl, supabaseKey)

  // تحقق من الاتصال أولاً
  async function testConnection() {
    console.log('جاري اختبار الاتصال بقاعدة البيانات...')
    
    // 1. تحقق من وجود الجدول
    const { data: tables, error: tablesError } = await supabase
      .from('employees')
      .select('*')
      .limit(1)
    
    if (tablesError) {
      console.error('خطأ في الاتصال:', tablesError)
      alert('خطأ في الاتصال بقاعدة البيانات: ' + tablesError.message)
      return false
    }
    
    console.log('الاتصال ناجح! البيانات:', tables)
    return true
  }

  // 2. تحقق من بيانات المستخدمين
  async function checkUsers() {
    const { data: users, error } = await supabase
      .from('employees')
      .select('username, role_id')
    
    if (error) {
      console.error('خطأ في جلب المستخدمين:', error)
      return
    }
    
    console.log('المستخدمون المتاحون:', users)
    alert('المستخدمون في النظام: ' + users.map(u => u.username).join(', '))
  }

  // 3. دالة تسجيل الدخول المعدلة
  async function login() {
    const username = document.getElementById('username').value.trim()
    const password = document.getElementById('password').value.trim()

    if (!username || !password) {
      alert('يرجى إدخال اسم المستخدم وكلمة المرور');
      return;
    }

    console.log('محاولة تسجيل دخول باسم:', username)

    // جرب أولاً: البحث عن المستخدم فقط
    const { data: user, error: userError } = await supabase
      .from('employees')
      .select('*')
      .eq('username', username)
      .single()

    console.log('نتيجة البحث عن المستخدم:', user)
    console.log('خطأ البحث:', userError)

    if (userError || !user) {
      alert('اسم المستخدم غير صحيح')
      return
    }

    // جرب ثانياً: التحقق من كلمة المرور
    // ملاحظة: إذا كانت كلمة المرور مشفرة، تحتاج لمقارنة مختلفة
    const { data, error } = await supabase
      .from('employees')
      .select('*')
      .eq('username', username)
      .eq('password_hash', password)
      .single()

    if (error || !data) {
      // جرب بدون تشفير (إذا كان الحقل اسمه password)
      const { data: data2, error: error2 } = await supabase
        .from('employees')
        .select('*')
        .eq('username', username)
        .eq('password', password)  // اسم حقل مختلف
        .single()
      
      if (error2 || !data2) {
        alert('كلمة المرور غير صحيحة')
        return
      }
      
      // نجح مع password
      proceedLogin(data2)
    } else {
      // نجح مع password_hash
      proceedLogin(data)
    }
  }

  function proceedLogin(userData) {
    console.log('تم تسجيل الدخول بنجاح!', userData)
    alert('مرحباً ' + userData.username + '! تم تسجيل الدخول بنجاح')
    
    // حفظ بيانات الجلسة
    localStorage.setItem('user', JSON.stringify(userData))
    
    // التوجيه حسب الدور
    switch (userData.role_id) {
      case 5:
        window.location.href = 'adminDashboard.html'
        break
      case 2:
        window.location.href = 'teamManagerDashboard.html'
        break
      case 1:
        window.location.href = 'specialistDashboard.html'
        break
      default:
        alert('الدور غير معروف!')
    }
  }

  // ربط الأحداث
  document.addEventListener('DOMContentLoaded', async () => {
    // اختبر الاتصال عند تحميل الصفحة
    const connected = await testConnection()
    if (connected) {
      await checkUsers()
    }
    
    // ربط زر الدخول
    document.getElementById('loginBtn').addEventListener('click', login)
    
    // تفعيل الدخول بالضغط على Enter
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        login()
      }
    })
  })
</script>